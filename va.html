

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Virtual Accelerator &mdash; phantasy-doc 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Quantity Interpretation" href="un.html" />
    <link rel="prev" title="PHANTASY Documentation" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> phantasy-doc
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">References</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Virtual Accelerator</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#how-to-set-up">How to Set Up</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installing-phantasy">Installing PHANTASY</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuration-files">Configuration Files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#starting-virtual-accelerator">Starting Virtual Accelerator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cli">CLI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#gui">GUI</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#scripting">Scripting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="un.html">Quantity Interpretation</a></li>
</ul>
<p class="caption"><span class="caption-text">Notebooks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="notebooks/va1.html">Online Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="notebooks/optlat.html">Optimize FLAME lattice</a></li>
</ul>
<p class="caption"><span class="caption-text">Applications</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="aris-apps.html">ARIS Apps</a></li>
</ul>
<p class="caption"><span class="caption-text">Others</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="slides.html">List of Slides</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">phantasy-doc</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Virtual Accelerator</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/va.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="virtual-accelerator">
<span id="va-ref-label"></span><h1>Virtual Accelerator<a class="headerlink" href="#virtual-accelerator" title="Permalink to this headline">¶</a></h1>
<p>The virtual accelerator (VA) application is driven by the framework <code class="docutils literal notranslate"><span class="pre">phantasy</span></code> using a set of configuration files,
which describe the accelerator beamline layout, controls process variables
used to establish EPICS IOC environment, and nominal device settings.</p>
<p>VA can be launched from a terminal by using <code class="docutils literal notranslate"><span class="pre">phantasy</span></code> commands or via a <code class="docutils literal notranslate"><span class="pre">phantasy-apps</span></code> GUI application.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">phantasy</span></code> framework also provides libraries that enable OOP scripting against the virtual
accelerator in any Python terminal, e.g. Jupyter-Notebook, to investigate and control the machine, such as by
build tuning algorithms. <code class="docutils literal notranslate"><span class="pre">phantasy-ui</span></code>, together with <code class="docutils literal notranslate"><span class="pre">mpl4qt</span></code>, provide useful templates and
libraries for efficient development of high-level applications (HLAs).</p>
<div class="section" id="how-to-set-up">
<h2>How to Set Up<a class="headerlink" href="#how-to-set-up" title="Permalink to this headline">¶</a></h2>
<p>What follows is a description for setting up the system environment for developing
VA configuration files. Currently, FLAME is the supported simulation engine.</p>
<div class="section" id="installing-phantasy">
<h3>Installing PHANTASY<a class="headerlink" href="#installing-phantasy" title="Permalink to this headline">¶</a></h3>
<p>Install or update <code class="docutils literal notranslate"><span class="pre">phantasy</span></code> in your VirtualBox. It should already be installed on appliance version v7 or later (e.g. develop-vmph0-v7).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt update
sudo apt install python3-phantasy python3-phantasy-apps python3-phantasy-ui
sudo apt install phantasy-machines
</pre></div>
</div>
<p>If already installed, it is recommended to do an update via <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">update</span> <span class="pre">&amp;&amp;</span> <span class="pre">sudo</span> <span class="pre">apt</span> <span class="pre">upgrade</span></code>.</p>
<p>As the package names imply, the distribution of <code class="docutils literal notranslate"><span class="pre">phantasy</span></code> includes both framework software and
the ready-to-use HLAs. The distributed machine configuration files make HLAs machine agnostic.</p>
</div>
<div class="section" id="configuration-files">
<h3>Configuration Files<a class="headerlink" href="#configuration-files" title="Permalink to this headline">¶</a></h3>
<p>The default machine configuration files are installed at directory  <cite>/usr/lib/phantasy-machines</cite>.
Pointing to user-customized locations is supported for local development.</p>
<p>Define the environmental variable <code class="docutils literal notranslate"><span class="pre">PHANTASY_CONFIG_DIR</span></code> in the current Terminal session
(temporary) or in user’s <cite>.bashrc</cite> file (persistent).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PHANTASY_CONFIG_DIR</span><span class="o">=</span>&lt;directory <span class="k">for</span> machine configuration files&gt;
</pre></div>
</div>
<p>For example, the following snippet initializes the directory which contains the configuration files
under development at a user’s home directory <cite>devuser</cite>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~
$ <span class="nb">pwd</span>
/home/devuser
$ git clone https://stash.frib.msu.edu/scm/phyapp/phantasy-machines.git -b devel
</pre></div>
</div>
<p>Consequently, the way to persistently set the <cite>PHANTASY_CONFIG_DIR</cite> is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">echo</span> <span class="s1">&#39;export PHANTASY_CONFIG_DIR=/home/devuser/phantasy-machines&#39;</span> &gt;&gt; ~/.bashrc
</pre></div>
</div>
<p>All changes within the directory <cite>/home/devuser/phantasy-machines</cite> should then be tested.</p>
</div>
</div>
<div class="section" id="starting-virtual-accelerator">
<h2>Starting Virtual Accelerator<a class="headerlink" href="#starting-virtual-accelerator" title="Permalink to this headline">¶</a></h2>
<p>There are two ways, i.e. through command line interface (CLI) and graphical user interface (GUI) to start the VA.
One is using the <code class="docutils literal notranslate"><span class="pre">flame-vastart</span></code> tool of <code class="docutils literal notranslate"><span class="pre">phantasy</span></code>, the other is via the <code class="docutils literal notranslate"><span class="pre">va_launcher</span></code> HLA of <code class="docutils literal notranslate"><span class="pre">phantasy-apps</span></code>.</p>
<div class="section" id="cli">
<h3>CLI<a class="headerlink" href="#cli" title="Permalink to this headline">¶</a></h3>
<p>The following is the command line to use for the case of starting the VA for a beamline section referred to as ARIS/F1 (i.e. machine/segment):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ phytool flame-vastart --mach ARIS --subm F1
</pre></div>
</div>
<p>The use description of <cite>flame-vastart</cite> tool is called using <cite>phytool flame-vastart -h</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ phytool flame-vastart -h
usage: phytool flame-vastart <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-v <span class="o">[</span>VERBOSITY<span class="o">]]</span> <span class="o">[</span>-l <span class="o">[</span>LOCALONLY<span class="o">]]</span>
                         <span class="o">[</span>--mach MACHINE<span class="o">]</span> <span class="o">[</span>--subm SUBMACH<span class="o">]</span>
                         <span class="o">[</span>--layout LAYOUTPATH<span class="o">]</span> <span class="o">[</span>--settings SETTINGSPATH<span class="o">]</span>
                         <span class="o">[</span>--config CONFIGPATH<span class="o">]</span> <span class="o">[</span>--cfsurl CFSURL<span class="o">]</span>
                         <span class="o">[</span>--cfstag CFSTAG<span class="o">]</span> <span class="o">[</span>--start START<span class="o">]</span> <span class="o">[</span>--end END<span class="o">]</span>
                         <span class="o">[</span>--data DATAPATH<span class="o">]</span> <span class="o">[</span>--work WORKPATH<span class="o">]</span>
                         <span class="o">[</span>--pv-prefix PVPREFIX<span class="o">]</span> <span class="o">[</span>--pv-suffix PVSUFFIX<span class="o">]</span>
                         <span class="o">[</span>--noise NOISE<span class="o">]</span> <span class="o">[</span>--rep-rate REPRATE<span class="o">]</span>

Start the virtual accelerator using FLAME simulation

optional arguments:
  -h, --help            show this <span class="nb">help</span> message and <span class="nb">exit</span>
  -v <span class="o">[</span>VERBOSITY<span class="o">]</span>        <span class="nb">set</span> the amount of output
  -l <span class="o">[</span>LOCALONLY<span class="o">]</span>        run IOC localhost only
  --mach MACHINE        name of machine or path of machine directory
  --subm SUBMACH        name of segment
  --layout LAYOUTPATH   path of accelerator layout file <span class="o">(</span>.csv<span class="o">)</span>
  --settings SETTINGSPATH
                        path to accelerator settings file <span class="o">(</span>.json<span class="o">)</span>
  --config CONFIGPATH   path to accelerator configuration file <span class="o">(</span>.ini<span class="o">)</span>
  --cfsurl CFSURL       url of channel finder service or <span class="nb">local</span> sqlite file
  --cfstag CFSTAG       tag to query <span class="k">for</span> channels
  --start START         name of accelerator element to start processing
  --end END             name of accelerator element to end processing
  --data DATAPATH       path to directory with FLAME data
  --work WORKPATH       path to directory <span class="k">for</span> executing FLAME
  --pv-prefix PVPREFIX  string prefix to each PV name
  --pv-suffix PVSUFFIX  string suffix only to noise/mps/status PVs
  --noise NOISE         noise level of device readback
  --rep-rate REPRATE    repetition rate of virtual accelerator
</pre></div>
</div>
<p>Typical optional arguments are <cite>–noise</cite> (default is 0.001), and
<cite>–rep-rate</cite> (default is 1 Hz). If neither <code class="docutils literal notranslate"><span class="pre">--pv-prefix</span></code> nor <code class="docutils literal notranslate"><span class="pre">--pv-suffix</span></code> is defined,
then default PV names for noise and rep-rate is <code class="docutils literal notranslate"><span class="pre">VA:SVR:NOISE</span></code> and <code class="docutils literal notranslate"><span class="pre">VA:SVR:RATE</span></code>, respectively.
One can use EPICS commands <code class="docutils literal notranslate"><span class="pre">caget</span></code> and <code class="docutils literal notranslate"><span class="pre">caput</span></code> to get and set the value; see the command
useage by <cite>-h</cite> flag.</p>
</div>
<div class="section" id="gui">
<h3>GUI<a class="headerlink" href="#gui" title="Permalink to this headline">¶</a></h3>
<p>For development, one can execute <code class="docutils literal notranslate"><span class="pre">va_launcher</span></code> command in the Terminal to
start the HLA for VA.</p>
<a class="reference internal image-reference" href="_images/va_launcher.png"><img alt="_images/va_launcher.png" class="align-center" src="_images/va_launcher.png" style="width: 600px;" /></a>
<p>Select/edit the names of machine and segment, and other options that are available.
The noise level and rep-rate could also be easily adjusted through the UI controls.</p>
</div>
</div>
<div class="section" id="scripting">
<h2>Scripting<a class="headerlink" href="#scripting" title="Permalink to this headline">¶</a></h2>
<p>This section shows how to use the API provide by <code class="docutils literal notranslate"><span class="pre">phantasy</span></code> to read and set the values in the OOP way.
This allows one to use Python scripts to monitor the VA status and apply desired changes, and do online simulation.
It is recommended to use Jupyter-Notebook, <a class="reference internal" href="notebooks/va1.html#Online-Modeling"><span class="std std-ref">the linked notebook</span></a> as shown here for an example.</p>
<p>Other <code class="docutils literal notranslate"><span class="pre">phantasy</span></code> based HLAs also could work with the VA by connecting to
the right machine/segment.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="un.html" class="btn btn-neutral float-right" title="Quantity Interpretation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="PHANTASY Documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2021, Tong Zhang, FRIB, Michigan State University
      <span class="lastupdated">
        Last updated on 2021-10-07T13:37:44 UTC.
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>